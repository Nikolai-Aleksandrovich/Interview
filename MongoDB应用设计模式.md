# 嵌入还是引用？

## 什么是范式？

数据库设计三大范式：

* 第一**范式**(确保每列保持**原子性**) 

  第一**范式**是最基本的**范式**。 如果**数据库**表中的所有字段值都是不可分解的原子值，就说明该数据库表满足了第一范式。

* 第二范式（数据的**唯一性**）(确保表中的每列都和主键相关)

  第二范式需要确保数据库表中的每一列都和主键相关，而不能只与主键的某一部分相关（主要针对联合主键而言）。也就是说在一个数据库表中，一个表中只能保存一种数据，不可以把多种数据保存在同一张数据库表中。

* 第三范式（对字段的**冗余性**）(确保每列都和主键列直接相关,而不是间接相关)

在MongoDB中，第一范式是：所有数据都是表格化的，每一个行列交汇处都有一个确切的数组，而不是关系型数据库的一个值

MongoDB的一个概念是：数据不用总是列成表格

MongoDB文档格式是使用JSON（JavaScript Object Notation）格式建模的，实际上是存在BSON（Binary JSON）中

MongoDB文档是一个键值对的字典，值可以是：

* 简单JSON类型（数字，字符串，布尔类型）
* 简单BSON类型（日期，ObjectId，UUID，正则表达式）
* 值数组
* 键值对象
* Null

### 局部性嵌入

嵌入的最大缺点是，查询的数据大于实际地需要量

数据局部性是希望嵌入一对多关系的原因，磁盘在随机寻址很费时，所以通过局部嵌入避免联合查询。

### 原子性和独立性嵌入

关系型数据库使用事务来完成原子性，MongoDB使用嵌入模式，就可以用单个操作完成原子性

**使用MongoDB，没有多文档事务，为什么设计时没有设计事务？**

底层设计时就考虑了如何简单的扩展到的多台服务器上，分布式数据库的两个问题：**分布式Join**和**分布式事务**，因为一个服务器在不可访问时会导致性能下降，那么就不支持Join和多文档事务，MongoDB可以实现自动地分片解决方案，可以获得比Join和事务更好的扩展性和性能

### 为了灵活性采用引用

一种考虑是将用户数据模型标准化到多个容器，可以提升查询的灵活性

如果应用程序需要多种方式查询数据，而且无法预计数据查询的模式，那么标准化的更好

### 为了潜在的高引用关系使用引用

当有十分高或者无法预测地引数地一对多关系时，要使用文档引用，如果要将一个文档嵌入在另外一个文档中，如果该文档过大，嵌入式会带来明显损失：

* 文档很大，使用的内存很大
* 增长的文档必然要拷贝到更大的空间中
* MongoDB的文档不能超过16MB

### 多对多的关系

多对多关系倾向于使用文档的引用，可以避免很多Join操作，可以将对象完全嵌入存储在另外一个对象中，但是在更新的时候也需要更新嵌入到该对象的文档信息，这时候应该折中，嵌入一个ID列表，而不嵌入完整的文档

## 总结

嵌入总文档的好处：

* 数据局部保存在一个文档中
* 有能力对单个文档执行原子性更新
* 但没办法处理高引用数的关系，造成性能问题

## 多态模式

MongoDB的多态模式方便父类和子类的存储，可以使用相同的集合来对所有内容结点共享的通用字段执行查询

多态模式也方便表扩展

